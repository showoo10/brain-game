<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ë‘ë‡Œ ê¸°ì–µë ¥ ê²Œì„ (ë­í‚¹ + ëª¨ë°”ì¼ ëŒ€ì‘)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
    :root {
        --bg-main: radial-gradient(circle at top, #151826 0, #02010b 55%, #000 100%);
        --card-bg: rgba(10, 12, 24, 0.98);
        --card-border: rgba(148, 163, 184, 0.18);
        --accent: #6366f1;
        --accent2: #ec4899;
        --text-main: #f9fafb;
        --text-sub: #9ca3af;
        --chip-bg: #0b1020;
        --chip-border: #33364a;
        --chip-bg-active: linear-gradient(120deg, #4f46e5, #ec4899);
    }

    * { box-sizing: border-box; }

    body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: var(--bg-main);
        color: var(--text-main);
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 12px;
    }

    .card {
        background: radial-gradient(circle at top left, rgba(148,163,255,0.12) 0, transparent 50%),
                    radial-gradient(circle at bottom right, rgba(236,72,153,0.12) 0, transparent 55%),
                    var(--card-bg);
        border-radius: 22px;
        padding: 20px 20px 24px;
        max-width: 900px;
        width: min(100%, 900px);
        border: 1px solid var(--card-border);
        box-shadow:
            0 28px 80px rgba(15,23,42,0.9),
            0 0 0 1px rgba(15,23,42,0.9);
        backdrop-filter: blur(16px);
    }

    h1 {
        margin: 0 0 4px;
        font-size: clamp(22px, 3.2vw, 28px);
        text-align: center;
        letter-spacing: 0.08em;
    }

    .subtitle {
        text-align: center;
        font-size: 12px;
        color: var(--text-sub);
        margin-bottom: 14px;
    }

    /* ìƒë‹¨ íƒ­: ê²Œì„ / ë­í‚¹ */
    .top-tabs {
        display: inline-flex;
        background: #020617;
        border-radius: 999px;
        padding: 3px;
        border: 1px solid rgba(55,65,81,0.9);
        margin: 0 auto 12px;
    }
    .top-tab {
        min-width: 90px;
        padding: 7px 16px;
        border-radius: 999px;
        border: none;
        background: transparent;
        color: var(--text-sub);
        font-size: 13px;
        cursor: pointer;
        transition: all 0.18s ease;
    }
    .top-tab.active {
        background: radial-gradient(circle at top, rgba(248,250,252,0.16), transparent 70%),
                    linear-gradient(120deg, #4f46e5, #ec4899);
        color: white;
        box-shadow: 0 10px 24px rgba(79,70,229,0.65);
    }

    #gameView, #rankView {
        margin-top: 12px;
    }

    /* ê³µí†µ ë²„íŠ¼ & ì¸í’‹ ë“± */
    .mode-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
    }
    .mode-btn {
        flex: 1;
        border-radius: 999px;
        border: 1px solid var(--chip-border);
        background: var(--chip-bg);
        color: #e5e7eb;
        padding: 8px 0;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.18s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }
    .mode-btn span.icon {
        font-size: 15px;
    }
    .mode-btn.active {
        background: var(--chip-bg-active);
        color: #f9fafb;
        border-color: transparent;
        transform: translateY(-1px);
        box-shadow: 0 8px 20px rgba(79,70,229,0.7);
    }

    .status-row {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: #c7c9ff;
        margin-bottom: 10px;
        gap: 8px;
        flex-wrap: wrap;
    }
    .status-row span strong { color: white; }
    .status-row .best { color: #fde68a; }

    .panel {
        border-radius: 18px;
        background:
            radial-gradient(circle at top, #111827, #020617);
        padding: 14px 14px 16px;
        margin-bottom: 14px;
        position: relative;
        overflow: hidden;
        box-shadow: inset 0 0 0 1px rgba(15,23,42,0.8);
    }
    .panel::before {
        content:"";
        position:absolute;
        inset:-40%;
        background:
            radial-gradient(circle at 0 0, rgba(56,189,248,0.07) 0,transparent 60%),
            radial-gradient(circle at 100% 100%, rgba(251,113,133,0.06) 0, transparent 55%);
        opacity:0.9;
        pointer-events:none;
    }
    .panel-inner { position: relative; z-index: 1; text-align: center; }

    #sequenceText {
        font-size: clamp(24px, 7vw, 40px);
        letter-spacing: 0.18em;
        margin: 4px 0 6px;
        min-height: 40px;
        opacity: 0;
        transform: translateY(8px);
        transition: all 0.24s ease-out;
    }
    #sequenceText.show {
        opacity: 1;
        transform: translateY(0);
    }

    #message, #messageColor {
        font-size: 12px;
        min-height: 18px;
        color: #e5e7eb;
    }

    .input-row {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-top: 10px;
    }
    #numberInput {
        padding: 8px 12px;
        border-radius: 999px;
        border: 1px solid #4b5563;
        background: #020617;
        color: #f9fafb;
        width: 60%;
        max-width: 260px;
        text-align: center;
        font-size: 16px;
    }
    #numberInput:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow:
            0 0 0 1px var(--accent),
            0 0 16px rgba(129,140,248,0.75);
    }

    .btn {
        border-radius: 999px;
        border: none;
        padding: 8px 16px;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.16s ease;
        font-weight: 500;
        white-space: nowrap;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
    }
    .btn-primary {
        background: linear-gradient(115deg, #4f46e5, #6366f1);
        color: #f9fafb;
        box-shadow: 0 10px 22px rgba(79,70,229,0.75);
    }
    .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 14px 28px rgba(79,70,229,0.85);
        filter: brightness(1.03);
    }
    .btn-ghost {
        background: rgba(15,23,42,0.9);
        color: #e5e7eb;
        border: 1px solid #4b5563;
    }
    .btn-ghost:hover {
        border-color: rgba(148,163,184,0.9);
        background: rgba(15,23,42,0.95);
    }

    .controls-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 10px;
    }
    .controls-row .btn {
        flex: 1;
        text-align: center;
    }
    @media (min-width: 761px) {
        .controls-row .btn {
            flex: 0 0 auto;
        }
    }

    .nickname-row {
        display: flex;
        gap: 6px;
        margin-top: 4px;
        align-items: center;
        font-size: 12px;
        color: var(--text-sub);
    }
    #nicknameInput {
        flex: 1;
        padding: 7px 10px;
        border-radius: 999px;
        border: 1px solid #4b5563;
        background: #020617;
        color: #f9fafb;
        font-size: 12px;
    }
    #nicknameInput:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 1px var(--accent);
    }

    /* ìƒ‰ íŒ¨í„´ ë³´ë“œ */
    .color-board-wrapper {
        margin-top: 10px;
        display: flex;
        justify-content: center;
    }
    .color-board {
        width: min(260px, 70vw);
        aspect-ratio: 1 / 1;
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        grid-template-rows: repeat(2, 1fr);
        gap: 10px;
    }
    .color-pad {
        border-radius: 18px;
        cursor: pointer;
        position: relative;
        opacity: 0.9;
        transition: all 0.14s ease-out;
        box-shadow:
            0 0 0 2px rgba(15,23,42,0.9),
            0 12px 20px rgba(0,0,0,0.7);
    }
    .color-pad span {
        position: absolute;
        bottom: 6px;
        right: 8px;
        font-size: 11px;
        color: rgba(15,23,42,0.75);
        font-weight: 600;
        text-shadow: 0 1px 2px rgba(255,255,255,0.85);
    }

    .pad-green { background: radial-gradient(circle at 20% 20%, #bbf7d0, #16a34a); }
    .pad-red   { background: radial-gradient(circle at 20% 20%, #fecaca, #dc2626); }
    .pad-yellow{ background: radial-gradient(circle at 20% 20%, #fef9c3, #eab308); }
    .pad-blue  { background: radial-gradient(circle at 20% 20%, #bfdbfe, #2563eb); }

    .color-pad.active {
        transform: scale(1.06) translateY(-1px);
        opacity: 1;
        box-shadow:
            0 0 22px rgba(255,255,255,0.9),
            0 18px 28px rgba(15,23,42,0.7);
    }
    .color-pad.locked {
        cursor: default;
        filter: grayscale(0.32);
        pointer-events: none;
        opacity: 0.75;
    }

    /* ë­í‚¹ í™”ë©´ ìŠ¤íƒ€ì¼ */
    .leaderboard {
        border-radius: 18px;
        background:
            radial-gradient(circle at top left, rgba(129,140,248,0.18) 0, transparent 55%),
            #020617;
        padding: 12px 14px 14px;
        border: 1px solid rgba(55,65,81,0.9);
        font-size: 12px;
        margin-top: 4px;
        box-shadow: 0 18px 40px rgba(15,23,42,0.95);
    }
    .leaderboard-title {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 8px;
        gap: 4px;
        flex-wrap: wrap;
    }
    .leaderboard-title h2 {
        margin: 0;
        font-size: 15px;
    }

    .leaderboard-mode-tabs {
        display: flex;
        gap: 6px;
        margin-bottom: 5px;
        font-size: 11px;
    }
    .lb-mode-tab {
        flex: 1;
        text-align: center;
        padding: 5px 0;
        border-radius: 999px;
        border: 1px solid #374151;
        cursor: pointer;
        color: #9ca3af;
        background: #020617;
        transition: all 0.16s ease;
    }
    .lb-mode-tab.active {
        background: radial-gradient(circle at top, rgba(248,250,252,0.12), transparent 60%),
                    linear-gradient(120deg, #4f46e5, #ec4899);
        color: #f9fafb;
        border-color: transparent;
        box-shadow: 0 8px 18px rgba(79,70,229,0.7);
    }

    .leaderboard-tabs {
        display: flex;
        gap: 6px;
        margin-bottom: 8px;
        font-size: 11px;
    }
    .lb-tab {
        flex: 1;
        text-align: center;
        padding: 5px 0;
        border-radius: 999px;
        border: 1px solid #374151;
        cursor: pointer;
        color: #9ca3af;
        background: #020617;
        transition: all 0.16s ease;
    }
    .lb-tab.active {
        background: #111827;
        color: #e5e7eb;
        border-color: #6366f1;
        box-shadow: 0 6px 14px rgba(15,23,42,0.9);
    }

    table {
        width: 100%;
        border-collapse: collapse;
        font-size: 11px;
        margin-top: 4px;
        background: rgba(15,23,42,0.6);
        border-radius: 12px;
        overflow: hidden;
    }
    th, td {
        padding: 5px 6px;
        text-align: left;
    }
    th {
        border-bottom: 1px solid #4b5563;
        color: #e5e7eb;
        font-weight: 500;
        background: rgba(15,23,42,0.95);
    }
    td.rank { width: 22px; color: #9ca3af; }
    tr:nth-child(even) td {
        background: rgba(15,23,42,0.82);
    }
    tr:nth-child(odd) td {
        background: rgba(15,23,42,0.65);
    }

    @media (max-width: 640px) {
        .card {
            padding: 16px 14px 20px;
            border-radius: 18px;
        }
        .leaderboard {
            padding: 10px 10px 12px;
        }
    }
</style>
</head>

<body>

<div class="card">
    <h1>ë‘ë‡Œ ê¸°ì–µë ¥ ê²Œì„</h1>
    <div class="subtitle">ìˆ«ì ê¸°ì–µ Â· ìƒ‰ íŒ¨í„´ Â· ê¸€ë¡œë²Œ ë­í‚¹ (PC/ëª¨ë°”ì¼ ì§€ì›)</div>

    <!-- ìƒë‹¨ íƒ­: ê²Œì„ / ë­í‚¹ -->
    <div style="display:flex;justify-content:center;">
        <div class="top-tabs">
            <button class="top-tab active" id="tabGame">ê²Œì„</button>
            <button class="top-tab" id="tabRank">ë­í‚¹</button>
        </div>
    </div>

    <!-- ğŸ® ê²Œì„ í™”ë©´ -->
    <div id="gameView">
        <div class="mode-tabs">
            <button class="mode-btn active" id="btnModeNumber">
                <span class="icon">ğŸ§®</span><span>ìˆ«ì ê¸°ì–µ</span>
            </button>
            <button class="mode-btn" id="btnModeColor">
                <span class="icon">ğŸ¨</span><span>ìƒ‰ íŒ¨í„´</span>
            </button>
        </div>

        <div class="status-row">
            <span>ëª¨ë“œ: <strong id="modeLabel">ìˆ«ì ê¸°ì–µ</strong></span>
            <span>ë ˆë²¨: <strong id="levelLabel">1</strong></span>
            <span class="best">ë‚´ ìµœê³ ë ˆë²¨: <strong id="bestLabel">0</strong></span>
        </div>

        <div class="panel">
            <div class="panel-inner" id="panelNumber">
                <div id="sequenceText"></div>
                <div id="message">ê²Œì„ ì‹œì‘ì„ ëˆ„ë¥´ë©´ ìˆ«ìê°€ ì ê¹ í‘œì‹œë©ë‹ˆë‹¤.</div>

                <div class="input-row" id="numberInputRow" style="display:none;">
                    <input type="text" id="numberInput" placeholder="ì…ë ¥">
                    <button class="btn btn-primary" id="btnSubmitNumber">ì œì¶œ</button>
                </div>
            </div>

            <div class="panel-inner" id="panelColor" style="display:none;">
                <div id="messageColor">ê²Œì„ ì‹œì‘ì„ ëˆ„ë¥´ë©´ íŒ¨í„´ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
                <div class="color-board-wrapper">
                    <div class="color-board">
                        <div class="color-pad pad-green" data-idx="0"><span>1</span></div>
                        <div class="color-pad pad-red" data-idx="1"><span>2</span></div>
                        <div class="color-pad pad-yellow" data-idx="2"><span>3</span></div>
                        <div class="color-pad pad-blue" data-idx="3"><span>4</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls-row">
            <button class="btn btn-primary" id="btnStart">ê²Œì„ ì‹œì‘ / ë‹¤ìŒ ë¼ìš´ë“œ</button>
            <button class="btn btn-ghost" id="btnStartBest">ìµœê³ ë ˆë²¨ì—ì„œ ì¬ë„ì „</button>
            <button class="btn btn-ghost" id="btnReset">ë‚´ ê¸°ë¡ ì´ˆê¸°í™”</button>
        </div>

        <div class="nickname-row">
            <span style="white-space:nowrap;">ë‹‰ë„¤ì„</span>
            <input id="nicknameInput" placeholder="ì˜ˆ: ì‹œí˜¸">
            <button class="btn btn-ghost" id="btnSaveName" style="padding:5px 10px;font-size:11px;">ì €ì¥</button>
        </div>
        <div style="font-size:11px;color:#9ca3af;margin-top:4px;">
            â€» ì‹¤íŒ¨ ì‹œ í˜„ì¬ ë ˆë²¨ì´ ìë™ìœ¼ë¡œ ì„œë²„ì— ì €ì¥ë˜ê³ , ë­í‚¹ íƒ­ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.
        </div>
    </div>

    <!-- ğŸ“Š ë­í‚¹ í™”ë©´ -->
    <div id="rankView" style="display:none;">
        <div class="leaderboard">
            <div class="leaderboard-title">
                <h2>ë­í‚¹ TOP 10</h2>
                <small id="leaderboardModeLabel">ë­í‚¹: ìˆ«ì ê¸°ì–µ / ì „ì²´</small>
            </div>

            <!-- ë­í‚¹ ëª¨ë“œ íƒ­ (ìˆ«ì/ìƒ‰) -->
            <div class="leaderboard-mode-tabs">
                <button class="lb-mode-tab active" data-rank-mode="number" id="lbModeNumber">ìˆ«ì ê¸°ì–µ</button>
                <button class="lb-mode-tab" data-rank-mode="color" id="lbModeColor">ìƒ‰ íŒ¨í„´</button>
            </div>

            <!-- ê¸°ê°„ íƒ­ -->
            <div class="leaderboard-tabs">
                <button class="lb-tab active" data-range="all" id="lbTabAll">ì „ì²´</button>
                <button class="lb-tab" data-range="week" id="lbTabWeek">ì´ë²ˆ ì£¼</button>
                <button class="lb-tab" data-range="today" id="lbTabToday">ì˜¤ëŠ˜</button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>ë‹‰ë„¤ì„</th>
                        <th>ë ˆë²¨</th>
                        <th>ê¸°ë¡ ì‹œê°„</th>
                    </tr>
                </thead>
                <tbody id="leaderboardBody">
                    <tr><td colspan="4">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Firebase CDN (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<script>
/* Firebase ì´ˆê¸°í™” (ì‹œí˜¸ë‹˜ í”„ë¡œì íŠ¸) */
const firebaseConfig = {
  apiKey: "AIzaSyAbGHsDFmQlXySnIK6y_hZMC4SNK7px-P4",
  authDomain: "brain-game-57799.firebaseapp.com",
  projectId: "brain-game-57799",
  storageBucket: "brain-game-57799.firebasestorage.app",
  messagingSenderId: "577688993292",
  appId: "1:577688993292:web:1c6647e31238b0e0407829",
  measurementId: "G-DRQ9NCX5YG"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ìƒíƒœ ë³€ìˆ˜ & DOM ì°¸ì¡° */
let currentMode = "number";       // ì‹¤ì œ ê²Œì„ ëª¨ë“œ
let currentRankMode = "number";   // ë­í‚¹ ëª¨ë“œ íƒ­ (ìˆ«ì/ìƒ‰)
let currentRange = "all";         // all / week / today

let levelNumber = 1;
let levelColor = 1;
let bestNumber = 0;
let bestColor = 0;

const tabGame = document.getElementById("tabGame");
const tabRank = document.getElementById("tabRank");
const gameView = document.getElementById("gameView");
const rankView = document.getElementById("rankView");

const modeLabel = document.getElementById("modeLabel");
const levelLabel = document.getElementById("levelLabel");
const bestLabel = document.getElementById("bestLabel");

const btnModeNumber = document.getElementById("btnModeNumber");
const btnModeColor = document.getElementById("btnModeColor");
const btnStart = document.getElementById("btnStart");
const btnStartBest = document.getElementById("btnStartBest");
const btnReset = document.getElementById("btnReset");

const seqText = document.getElementById("sequenceText");
const msg = document.getElementById("message");
const numberInputRow = document.getElementById("numberInputRow");
const numberInput = document.getElementById("numberInput");
const btnSubmitNumber = document.getElementById("btnSubmitNumber");

const panelNumber = document.getElementById("panelNumber");
const panelColor = document.getElementById("panelColor");
const msgColor = document.getElementById("messageColor");
const pads = Array.from(document.querySelectorAll(".color-pad"));

const nicknameInput = document.getElementById("nicknameInput");
const btnSaveName = document.getElementById("btnSaveName");
const leaderboardBody = document.getElementById("leaderboardBody");
const leaderboardModeLabel = document.getElementById("leaderboardModeLabel");

const lbModeNumber = document.getElementById("lbModeNumber");
const lbModeColor = document.getElementById("lbModeColor");
const lbModeTabs = [lbModeNumber, lbModeColor];

const lbTabAll = document.getElementById("lbTabAll");
const lbTabWeek = document.getElementById("lbTabWeek");
const lbTabToday = document.getElementById("lbTabToday");
const lbTabs = [lbTabAll, lbTabWeek, lbTabToday];

let currentSequence = "";
let acceptingNumberInput = false;

let colorSequence = [];
let userColorIndex = 0;
let acceptingColorInput = false;

/* ë¡œì»¬ ì €ì¥ (ìµœê³ ë ˆë²¨ & ë‹‰ë„¤ì„) */
function loadLocalSettings() {
    bestNumber = parseInt(localStorage.getItem("brainGame_best_number") || "0", 10);
    bestColor = parseInt(localStorage.getItem("brainGame_best_color") || "0", 10);
    const storedName = localStorage.getItem("brainGame_nickname") || "";
    nicknameInput.value = storedName;
}
function saveBestScores() {
    localStorage.setItem("brainGame_best_number", bestNumber.toString());
    localStorage.setItem("brainGame_best_color", bestColor.toString());
}
function saveNickname() {
    const name = nicknameInput.value.trim();
    localStorage.setItem("brainGame_nickname", name);
}

/* UI ìƒíƒœ ì—…ë°ì´íŠ¸ */
function updateStatusBar() {
    const rangeLabel =
        currentRange === "all" ? "ì „ì²´" :
        currentRange === "week" ? "ì´ë²ˆ ì£¼" :
        "ì˜¤ëŠ˜";

    // ê²Œì„ ìª½ í‘œì‹œ
    if (currentMode === "number") {
        modeLabel.textContent = "ìˆ«ì ê¸°ì–µ";
        levelLabel.textContent = levelNumber;
        bestLabel.textContent = bestNumber;
    } else {
        modeLabel.textContent = "ìƒ‰ íŒ¨í„´";
        levelLabel.textContent = levelColor;
        bestLabel.textContent = bestColor;
    }

    // ë­í‚¹ ìª½ í‘œì‹œ
    const rankModeLabel = currentRankMode === "number" ? "ìˆ«ì ê¸°ì–µ" : "ìƒ‰ íŒ¨í„´";
    leaderboardModeLabel.textContent = `ë­í‚¹: ${rankModeLabel} / ${rangeLabel}`;
}

/* ë­í‚¹ ê¸°ê°„ ê³„ì‚° */
function getRangeStartDate(range) {
    const now = new Date();
    if (range === "today") {
        return new Date(now.getFullYear(), now.getMonth(), now.getDate());
    }
    if (range === "week") {
        return new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
    }
    return null; // ì „ì²´
}

/* ì ìˆ˜ ì„œë²„ ì „ì†¡ (ë‹¨ìˆœ add) */
async function submitScoreToServer(mode, score) {
    try {
        let name = nicknameInput.value.trim();
        if (!name) name = "ìµëª…";

        await db.collection("scores").add({
            name,
            mode,  // "number" or "color"
            score,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        loadLeaderboard();
    } catch (err) {
        console.error("ì ìˆ˜ ì €ì¥ ì‹¤íŒ¨:", err);
    }
}

/* ë­í‚¹ ë¡œë”© */
async function loadLeaderboard() {
    try {
        const modeValue = currentRankMode === "number" ? "number" : "color";
        leaderboardBody.innerHTML = '<tr><td colspan="4">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>';

        let query = db.collection("scores").where("mode", "==", modeValue);
        const startDate = getRangeStartDate(currentRange);
        if (startDate) {
            query = query.where("createdAt", ">=", startDate);
        }

        query = query
            .orderBy("score", "desc")
            .orderBy("createdAt", "asc")
            .limit(10);

        const snap = await query.get();

        if (snap.empty) {
            leaderboardBody.innerHTML =
                '<tr><td colspan="4">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ê¸°ë¡ì˜ ì£¼ì¸ì´ ë˜ì–´ë³´ì„¸ìš”!</td></tr>';
            return;
        }

        let html = "";
        let rank = 1;
        snap.forEach(doc => {
            const data = doc.data();
            const name = (data.name || "ìµëª…").slice(0, 16);
            const score = data.score || 0;
            const ts = data.createdAt && data.createdAt.toDate ? data.createdAt.toDate() : null;
            const timeStr = ts
                ? `${ts.getFullYear()}.${String(ts.getMonth()+1).padStart(2,'0')}.${String(ts.getDate()).padStart(2,'0')} ${String(ts.getHours()).padStart(2,'0')}:${String(ts.getMinutes()).padStart(2,'0')}`
                : "-";
            html += `
                <tr>
                    <td class="rank">${rank}</td>
                    <td>${name}</td>
                    <td>${score}</td>
                    <td>${timeStr}</td>
                </tr>
            `;
            rank++;
        });
        leaderboardBody.innerHTML = html;
    } catch (err) {
        console.error("ë­í‚¹ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
        leaderboardBody.innerHTML =
            '<tr><td colspan="4">ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
    }
}

/* ìƒë‹¨ íƒ­ ì „í™˜: ê²Œì„ / ë­í‚¹ */
function switchTopTab(tab) {
    if (tab === "game") {
        tabGame.classList.add("active");
        tabRank.classList.remove("active");
        gameView.style.display = "block";
        rankView.style.display = "none";
    } else {
        tabRank.classList.add("active");
        tabGame.classList.remove("active");
        gameView.style.display = "none";
        rankView.style.display = "block";
        loadLeaderboard();
    }
}

/* ê²Œì„ ëª¨ë“œ ì „í™˜ (ìˆ«ì/ìƒ‰) */
function switchMode(mode) {
    currentMode = mode;

    if (mode === "number") {
        btnModeNumber.classList.add("active");
        btnModeColor.classList.remove("active");
        panelNumber.style.display = "block";
        panelColor.style.display = "none";
        resetNumberUI();
    } else {
        btnModeColor.classList.add("active");
        btnModeNumber.classList.remove("active");
        panelNumber.style.display = "none";
        panelColor.style.display = "block";
        resetColorUI();
    }
    updateStatusBar();
}

/* ë­í‚¹ ëª¨ë“œ íƒ­ ì „í™˜ (ìˆ«ì/ìƒ‰) */
function switchRankMode(mode) {
    currentRankMode = mode;
    lbModeTabs.forEach(tab => {
        if (tab.getAttribute("data-rank-mode") === mode) {
            tab.classList.add("active");
        } else {
            tab.classList.remove("active");
        }
    });
    updateStatusBar();
    loadLeaderboard();
}

/* ë­í‚¹ ê¸°ê°„ íƒ­ ì „í™˜ */
function switchRange(range) {
    currentRange = range;
    lbTabs.forEach(tab => {
        if (tab.getAttribute("data-range") === range) {
            tab.classList.add("active");
        } else {
            tab.classList.remove("active");
        }
    });
    updateStatusBar();
    loadLeaderboard();
}

/* ìˆ«ì ëª¨ë“œ ë¡œì§ */
function resetNumberUI() {
    seqText.textContent = "";
    seqText.classList.remove("show");
    msg.textContent = "ê²Œì„ ì‹œì‘ì„ ëˆ„ë¥´ë©´ ìˆ«ìê°€ ì ê¹ í‘œì‹œë©ë‹ˆë‹¤.";
    numberInputRow.style.display = "none";
    acceptingNumberInput = false;
}

function generateNumberSequence(len) {
    let s = "";
    for (let i = 0; i < len; i++) {
        s += Math.floor(Math.random() * 10);
    }
    return s;
}

function startNumberRound() {
    acceptingNumberInput = false;
    numberInputRow.style.display = "none";

    const len = levelNumber + 2;
    currentSequence = generateNumberSequence(len);

    msg.textContent = "ìˆ«ìë¥¼ ì§‘ì¤‘í•´ì„œ ë³´ì„¸ìš”...";
    seqText.textContent = currentSequence.split("").join(" ");
    setTimeout(() => seqText.classList.add("show"), 30);

    const showTime = 1200 + len * 400;

    setTimeout(() => {
        seqText.classList.remove("show");
        setTimeout(() => {
            seqText.textContent = "";
            msg.textContent = "ì…ë ¥í•´ ë³´ì„¸ìš”.";
            numberInputRow.style.display = "flex";
            numberInput.value = "";
            numberInput.focus();
            acceptingNumberInput = true;
        }, 220);
    }, showTime);
}

function checkNumberAnswer() {
    if (!acceptingNumberInput) return;
    const user = numberInput.value.trim().replace(/\s+/g, "");
    acceptingNumberInput = false;
    const reachedLevel = levelNumber - 1;

    if (user === currentSequence) {
        msg.textContent = "ì •ë‹µ! ë ˆë²¨ì—… ğŸ‰";
        levelNumber++;
        if (levelNumber - 1 > bestNumber) {
            bestNumber = levelNumber - 1;
            saveBestScores();
        }
        updateStatusBar();
        setTimeout(startNumberRound, 900);
    } else {
        msg.textContent = `í‹€ë¦¼! ì •ë‹µ: ${currentSequence}`;
        numberInputRow.style.display = "none";

        const score = Math.max(reachedLevel, 1);
        if (score > bestNumber) {
            bestNumber = score;
            saveBestScores();
        }
        levelNumber = 1;
        updateStatusBar();
        submitScoreToServer("number", score);
    }
}

/* ìƒ‰ íŒ¨í„´ ëª¨ë“œ ë¡œì§ */
function resetColorUI() {
    msgColor.textContent = "ê²Œì„ ì‹œì‘ì„ ëˆ„ë¥´ë©´ íŒ¨í„´ì´ í‘œì‹œë©ë‹ˆë‹¤.";
    pads.forEach(p => p.classList.add("locked"));
    colorSequence = [];
    acceptingColorInput = false;
    userColorIndex = 0;
}

function flashPad(idx, delay) {
    const pad = pads[idx];
    setTimeout(() => {
        pad.classList.add("active");
        setTimeout(() => pad.classList.remove("active"), 350);
    }, delay);
}

function playColorSequence() {
    acceptingColorInput = false;
    pads.forEach(p => p.classList.add("locked"));
    msgColor.textContent = "íŒ¨í„´ì„ ì˜ ë³´ì„¸ìš”...";

    let t = 300;
    colorSequence.forEach(idx => {
        flashPad(idx, t);
        t += 550;
    });

    setTimeout(() => {
        msgColor.textContent = "ê°™ì€ ìˆœì„œë¡œ ëˆŒëŸ¬ë³´ì„¸ìš”.";
        acceptingColorInput = true;
        pads.forEach(p => p.classList.remove("locked"));
        userColorIndex = 0;
    }, t + 150);
}

function startColorRound() {
    acceptingColorInput = false;
    pads.forEach(p => p.classList.add("locked"));

    colorSequence = [];
    const targetLength = Math.max(1, levelColor);
    for (let i = 0; i < targetLength; i++) {
        colorSequence.push(Math.floor(Math.random() * 4));
    }
    playColorSequence();
}

function handlePadClick(e) {
    if (!acceptingColorInput) return;

    const idx = parseInt(e.currentTarget.getAttribute("data-idx"), 10);
    e.currentTarget.classList.add("active");
    setTimeout(() => e.currentTarget.classList.remove("active"), 160);

    const reachedLevel = levelColor - 1;

    if (idx === colorSequence[userColorIndex]) {
        userColorIndex++;

        if (userColorIndex === colorSequence.length) {
            acceptingColorInput = false;
            pads.forEach(p => p.classList.add("locked"));
            msgColor.textContent = "ì •ë‹µ! ë‹¤ìŒ íŒ¨í„´ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.";
            levelColor++;
            if (levelColor - 1 > bestColor) {
                bestColor = levelColor - 1;
                saveBestScores();
            }
            updateStatusBar();
            setTimeout(startColorRound, 900);
        }
    } else {
        acceptingColorInput = false;
        pads.forEach(p => p.classList.add("locked"));
        msgColor.textContent = "í‹€ë ¸ìŠµë‹ˆë‹¤! ë‹¤ì‹œ ì²˜ìŒë¶€í„°.";

        const score = Math.max(reachedLevel, 1);
        if (score > bestColor) {
            bestColor = score;
            saveBestScores();
        }
        levelColor = 1;
        updateStatusBar();
        colorSequence = [];
        submitScoreToServer("color", score);
    }
}

/* ìµœê³ ë ˆë²¨ì—ì„œ ì¬ë„ì „ */
btnStartBest.addEventListener("click", () => {
    if (currentMode === "number") {
        if (bestNumber <= 0) {
            alert("ì•„ì§ ìµœê³  ë ˆë²¨ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤!");
            return;
        }
        levelNumber = bestNumber;
        updateStatusBar();
        resetNumberUI();
        setTimeout(startNumberRound, 200);
    } else {
        if (bestColor <= 0) {
            alert("ì•„ì§ ìµœê³  ë ˆë²¨ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤!");
            return;
        }
        levelColor = bestColor;
        updateStatusBar();
        resetColorUI();
        setTimeout(startColorRound, 200);
    }
});

/* ì´ë²¤íŠ¸ ì—°ê²° */
tabGame.addEventListener("click", () => switchTopTab("game"));
tabRank.addEventListener("click", () => switchTopTab("rank"));

btnStart.addEventListener("click", () => {
    if (currentMode === "number") startNumberRound();
    else startColorRound();
});
btnSubmitNumber.addEventListener("click", checkNumberAnswer);
numberInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") checkNumberAnswer();
});

pads.forEach(p => p.addEventListener("click", handlePadClick));

btnModeNumber.addEventListener("click", () => switchMode("number"));
btnModeColor.addEventListener("click", () => switchMode("color"));

btnReset.addEventListener("click", () => {
    if (!confirm("ë‚´ ë¸Œë¼ìš°ì €ì— ì €ì¥ëœ ìµœê³  ë ˆë²¨ ê¸°ë¡ì„ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?")) return;
    bestNumber = 0;
    bestColor = 0;
    levelNumber = 1;
    levelColor = 1;
    saveBestScores();
    resetNumberUI();
    resetColorUI();
    updateStatusBar();
});

btnSaveName.addEventListener("click", () => {
    saveNickname();
    alert("ë‹‰ë„¤ì„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œ ê¸°ë¡ì´ ì´ ì´ë¦„ìœ¼ë¡œ ì˜¬ë¼ê°‘ë‹ˆë‹¤.");
});

lbModeTabs.forEach(tab => {
    tab.addEventListener("click", () => {
        const mode = tab.getAttribute("data-rank-mode");
        switchRankMode(mode);
    });
});

lbTabs.forEach(tab => {
    tab.addEventListener("click", () => {
        const range = tab.getAttribute("data-range");
        switchRange(range);
    });
});

/* ì´ˆê¸°í™” */
loadLocalSettings();
switchTopTab("game");
switchMode("number");
switchRankMode("number");
switchRange("all");
updateStatusBar();
loadLeaderboard();
</script>
</body>
</html>
